FROM python:3.12-alpine3.19

RUN apk add --no-cache git gcc musl-dev libffi-dev openssl-dev cargo nodejs npm

RUN mkdir -p /wd/app
WORKDIR /wd/app

ARG GITHUB_ACCESS_TOKEN=''
ARG REPOSITORY_DESTINATION__APP='app'
ARG REPOSITORY_DESTINATION=${REPOSITORY_DESTINATION__APP}
ARG REPOSITORY_SOURCE='github.com/cqr-cryeye-forks/regexploit'
ARG REPOSITORY_COMMIT='aed7cc93a07af2b670ce6d5b2987454d146e646d'

RUN git clone --depth 1 \
        https://${GITHUB_ACCESS_TOKEN}@${REPOSITORY_SOURCE} \
        ${REPOSITORY_DESTINATION}

COPY . /wd/app

# Установка необходимых пакетов Python
RUN pip install --no-cache-dir --index-url=https://pypi.org/simple pyyaml==6.0.2
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir regexploit

# Установка модулей Node.js для JavaScript и TypeScript анализа
# Выполнение команды в директории, указанной в сообщении
RUN cd /usr/local/lib/python3.12/site-packages/regexploit/bin/javascript && npm install

RUN chmod +x /usr/local/bin/regexploit

ENTRYPOINT ["python3", "run_regexploit.py"]


CMD ["--repo-url", "https://github.com/WebGoat/WebGoat", "--output", "data.json"]
#CMD ["--input-zip", "", "--output", "data.json", "--git-ignore"]

#CMD ["--input-zip", "111.zip",  "--output", "data.json"]
#CMD ["--input-zip", "", "--repo-url", "https://github.com/digininja/DVWA", "--output", "data.json"]
#CMD ["--repo-url", "https://github.com/OWASP/NodeGoat", "--output", "data.json"]
